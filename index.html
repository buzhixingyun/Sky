<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>å…‰é‡èº«é«˜è§‚æµ‹ç«™</title>
    
    <!-- Performance Optimization -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://gitee.com">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- QR Scanner -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

    <!-- React & ReactDOM (UMD for static deployment) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for in-browser JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['"Noto Sans SC"', 'sans-serif'],
            },
            colors: {
              sky: {
                light: '#aac4ff',
                DEFAULT: '#6b8cce',
                dark: '#3d5a80',
              },
              gold: '#ffd60a',
            },
            animation: {
              'gradient-x': 'gradient-x 15s ease infinite',
              'float': 'float 6s ease-in-out infinite',
            },
            keyframes: {
              'gradient-x': {
                '0%, 100%': {
                  'background-size': '200% 200%',
                  'background-position': 'left center'
                },
                '50%': {
                  'background-size': '200% 200%',
                  'background-position': 'right center'
                },
              },
              'float': {
                '0%, 100%': { transform: 'translateY(0)' },
                '50%': { transform: 'translateY(-10px)' },
              }
            }
          }
        }
      }
    </script>
    <style>
      html {
        -webkit-tap-highlight-color: transparent;
      }
      body {
        margin: 0;
        padding: 0;
        overflow-x: hidden;
        touch-action: manipulation;
      }
      .pb-safe {
        padding-bottom: env(safe-area-inset-bottom);
      }
      .glass {
        background: rgba(15, 23, 42, 0.65);
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .glass-modal {
        background: rgba(10, 10, 20, 0.9);
        backdrop-filter: blur(24px);
        border: 1px solid rgba(255, 255, 255, 0.15);
      }
      .glass-input {
        background: rgba(0, 0, 0, 0.4);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
      .glass-btn {
        background: linear-gradient(135deg, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0.05) 100%);
        box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
      ::-webkit-scrollbar {
        width: 4px;
      }
      ::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
      }
      ::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.3);
        border-radius: 10px;
      }
      .scrollbar-hide::-webkit-scrollbar {
          display: none;
      }
      .scrollbar-hide {
          -ms-overflow-style: none;
          scrollbar-width: none;
      }
    </style>
  <script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.1",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.1/",
    "react/": "https://aistudiocdn.com/react@^19.2.1/"
  }
}
</script>
</head>
  <body class="min-h-[100dvh] font-sans text-white bg-gradient-to-br from-indigo-900 via-purple-900 to-slate-900 animate-gradient-x overflow-y-auto">
    <div class="fixed inset-0 pointer-events-none bg-[url('https://www.transparenttextures.com/patterns/stardust.png')] opacity-20 z-0"></div>
    <div id="root" class="w-full min-h-[100dvh] flex flex-col items-center justify-center p-4 md:p-6 relative z-10 pb-safe"></div>

    <!-- MAIN APPLICATION LOGIC -->
    <script type="text/babel">
      const { useState, useEffect, useRef, useCallback } = React;

      // --- Translations ---
      const translations = {
        measurement_notice_title: "æµ‹é‡é¡»çŸ¥",
        measurement_notice_body: "1. <b>æ•°æ®æ¥æºï¼š</b>åŸºäºæ¸¸æˆç”Ÿæˆçš„äºŒç»´ç æ•°æ®è¿›è¡Œæœ¬åœ°è§£æã€‚<br>2. <b>å®‰å…¨å£°æ˜ï¼š</b>æ‰€æœ‰è®¡ç®—å‡åœ¨æœ¬åœ°å®Œæˆï¼Œä¸ä¸Šä¼ ä»»ä½•æ•°æ®ã€‚<br>3. <b>èŒƒå›´ï¼š</b>èº«é«˜æ•°å€¼èŒƒå›´é€šå¸¸ä¸º 0 è‡³ 14ã€‚",
        title: "å…‰ä¹‹å­èº«é«˜è§‚æµ‹",
        toggle_instructions: "æŸ¥çœ‹æµ‹é‡æŒ‡å—",
        inst_1: "1. åœ¨æ¸¸æˆä¸­ï¼Œè¿›å…¥ <b>è®¾ç½® > æ›´å¤š > ç„¶åä¸€ç›´æ»‘åˆ°åº•</b>ã€‚",
        inst_2: "2. <b>æˆªå›¾</b><span class=\"text-rose-400 font-extrabold mx-1 text-lg\">çº¿ä¸‹æ´»åŠ¨å¤–è§‚äºŒç»´ç </span>ï¼Œç„¶åç‚¹å‡»ä¸Šä¼ ã€‚",
        inst_3: "3. æ‚¨å¯ä»¥é€‰æ‹©ä»¥ä¸‹ä¸¤ç§æ–¹å¼ä¹‹ä¸€ï¼š",
        inst_4: "<b>æ–¹å¼ä¸€ï¼šäºŒç»´ç æ³•</b><br>ç‚¹å‡»ã€Œä¸Šä¼ å›¾ç‰‡ã€åŒºåŸŸï¼Œä¸Šä¼ äºŒç»´ç åç‚¹å‡»å¼€å§‹è§‚æµ‹ã€‚",
        inst_5: "<b>æ–¹å¼äºŒï¼šç²˜è´´é“¾æ¥</b><br>ä½¿ç”¨å…¶ä»–æ‰«ç å·¥å…·æ‰«ç ï¼ˆå¦‚å¾®ä¿¡ã€æ”¯ä»˜å®ç­‰ï¼‰ <code>æ‰«ç ç»“æŸä¼šå‡ºç°https://sky.thatg.co/o=</code> å¼€å¤´çš„é“¾æ¥ï¼Œå¤åˆ¶å¹¶å¡«å…¥ä¸­é—´è¾“å…¥æ¡†ã€‚",
        input_label: "åœ¨æ­¤ç²˜è´´äºŒç»´ç é“¾æ¥ï¼š",
        placeholder: "https://sky.thatg.co/o=...",
        calculate_btn: "å¼€å§‹è§‚æµ‹",
        res_current: "å½“å‰èº«é«˜",
        res_tallest: "ç†è®ºæœ€é«˜",
        res_shortest: "ç†è®ºæœ€çŸ®",
        res_details: "è°ƒè¯•ä¿¡æ¯",
        copy_btn: "å¤åˆ¶æ•°æ®",
        image_btn: "ç”Ÿæˆå¡ç‰‡",
        status_calculating: "æ˜Ÿå…‰æ±‡èšä¸­...",
        status_error_empty: "è¯·è¾“å…¥å†…å®¹æˆ–ä¸Šä¼ å›¾ç‰‡",
        status_error_general: "æ— æ³•è¯†åˆ«è¯¥å†…å®¹ï¼Œè¯·æ£€æŸ¥é“¾æ¥æˆ–å›¾ç‰‡æ˜¯å¦æ­£ç¡®ã€‚",
        status_success: "è§‚æµ‹å®Œæˆ",
        status_copy_success: "å·²å¤åˆ¶åˆ°å‰ªè´´æ¿",
        status_copy_fail: "å¤åˆ¶å¤±è´¥",
        copy_btn_copied: "å·²å¤åˆ¶",
        history_title: "æ—¶å…‰è®°å½•",
        clear_history_btn: "æ¸…ç©º",
        history_current_label: "èº«é«˜",
        history_note_placeholder: "æ·»åŠ å¤‡æ³¨...",
        customize_image: "å®šåˆ¶åˆ†äº«å¡ç‰‡",
        player_name: "å…‰ä¹‹å­æ˜µç§°",
        player_name_placeholder: "è¾“å…¥æ˜µç§°...",
        bg_style_upload: "ä¸Šä¼ èƒŒæ™¯å›¾",
        bg_style_image: "é¢„è®¾èƒŒæ™¯",
        bg_style_gradient: "çº¯è‰²æµå…‰",
        text_color: "æ–‡å­—é¢œè‰²",
        text_white: "å…‰ç™½",
        text_black: "æš—å¤œ",
        confirm_clear_history: "ç¡®å®šè¦é—å¿˜æ‰€æœ‰è®°å½•å—ï¼Ÿ",
        confirm_delete_item: "ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ",
        item_deleted: "è®°å½•å·²ç§»é™¤",
        text_align: "å¯¹é½æ–¹å¼",
        align_center: "å±…ä¸­",
        align_left: "å±…å·¦",
        align_right: "å±…å³",
        show_range: "æ˜¾ç¤ºèŒƒå›´åŒºé—´",
        disclaimer_free: "å…è´¹æµ‹é‡ï¼Œå¥½ç”¨è¯·å¤šæ¨å¹¿ã€‚",
        disclaimer_privacy: "éå¤–æŒ‚ç±»éæ³•è·å–æ•°æ®æ‰€ä»¥ä¸å­˜åœ¨å°å·æƒ…å†µï¼Œè¯·å‹¿æ‹…å¿ƒã€‚",
        sim_title: "é‡å¡‘æ¨¡æ‹Ÿå™¨",
        sim_desc: "æ¨¡æ‹Ÿé¥®ç”¨é‡å¡‘è¯æ°´åçš„èº«é«˜å˜åŒ–ï¼ˆä»…ä¾›å¨±ä¹ï¼Œä¸ä»£è¡¨çœŸå®æ¦‚ç‡ï¼‰ã€‚",
        sim_drink_btn: "é¥®ç”¨è¯æ°´",
        sim_reset_btn: "é‡ç½®çŠ¶æ€",
        sim_meta_title: "ç„å­¦åŠ æˆ",
        sim_meta_tall: "ä¸é«˜ä¸ªå­ç‰µæ‰‹",
        sim_meta_short: "ä¸çŸ®ä¸ªå­ç‰µæ‰‹",
        sim_result_label: "æ¨¡æ‹Ÿç»“æœ",
        sim_count_label: "æ¶ˆè€—è¯æ°´",
        sim_error_no_calc: "è¯·å…ˆè¿›è¡Œä¸€æ¬¡èº«é«˜æµ‹é‡ä½œä¸ºåŸºå‡†ã€‚",
        sim_extreme_tall: "ï¼ˆè§¦åŠå¤©ç©ºçš„æé™ï¼ï¼‰",
        sim_extreme_short: "ï¼ˆéå…¥åœ°é¢çš„æé™ï¼ï¼‰",
        upload_instruction: "ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ æˆªå›¾",
        upload_btn: "é€‰æ‹©å›¾ç‰‡",
        status_qr_reading: "è¯»å–å›¾ç‰‡ä¸­...",
        status_qr_scanning: "å¯»æ‰¾äºŒç»´ç ...",
        status_qr_fail: "æœªå‘ç°äºŒç»´ç ï¼Œè¯·ç¡®ä¿æˆªå›¾æ¸…æ™°ã€‚",
        status_qr_success: "è¯†åˆ«æˆåŠŸï¼",
        status_copy_empty: "æš‚æ— æ•°æ®",
        tab_measure: "æµ‹é‡",
        tab_sim: "æ¨¡æ‹Ÿ",
        tab_history: "è®°å½•",
        entry_title: "å…‰é‡èº«é«˜è§‚æµ‹ç«™",
        entry_intro: "æ¬¢è¿å…‰ä¸´ã€‚æœ¬å·¥å…·æä¾›ä»¥ä¸‹åŠŸèƒ½ï¼š<br>âœ¨ <b>ç²¾å‡†æµ‹é‡</b>ï¼šåŸºäºäºŒç»´ç è§£æç²¾ç¡®æ•°å€¼<br>âœ¨ <b>é‡å¡‘æ¨¡æ‹Ÿ</b>ï¼šæ¨¡æ‹Ÿé­”æ³•è¯æ°´æ•ˆæœ<br>âœ¨ <b>å†å²è®°å½•</b>ï¼šè‡ªåŠ¨ä¿å­˜æ‚¨çš„æˆé•¿è½¨è¿¹",
        entry_warning: "âš ï¸ <b>æ–°æ‰‹å¿…è¯»ï¼š</b><br>è¿›å…¥åè¯·åŠ¡å¿…å…ˆç‚¹å‡»åº•éƒ¨çš„<span class='text-rose-400 font-bold'>ã€ŒæŸ¥çœ‹æµ‹é‡æŒ‡å—ã€</span>ï¼<br>æœªæŒ‰æŒ‡å—æ­¥éª¤æˆªå›¾å°†å¯¼è‡´æ— æ³•è¯†åˆ«ã€‚",
        entry_btn: "æˆ‘å·²çŸ¥æ™“ï¼Œè¿›å…¥è§‚æµ‹",
        entry_btn_wait: "è¯·ä»”ç»†é˜…è¯» (%s)",
      };

      const t = (key) => translations[key] || key;

      // --- Utils ---
      const decodeAndCalculate = (rawData) => {
        try {
          const startMarker = "ImJvZHki";
          const startIndex = rawData.indexOf(startMarker);
          if (startIndex === -1) {
              return { error: translations['status_error_general'] };
          }

          let b64Str = rawData.substring(startIndex);
          b64Str = b64Str.replace(/-/g, '+').replace(/_/g, '/');
          const padding = b64Str.length % 4;
          if (padding) {
              b64Str += '='.repeat(4 - padding);
          }

          const decodedText = atob(b64Str);
          let height;
          const heightKeyMatch = decodedText.match(/eigh/i);
          if (!heightKeyMatch) {
              return { error: translations['status_error_general'] };
          }

          const heightSearchArea = decodedText.substring(heightKeyMatch.index + heightKeyMatch[0].length);
          const heightMatch = heightSearchArea.match(/(-?\d*\.\d+|-?\d+\.?\d*)/);
          if (heightMatch) {
              height = parseFloat(heightMatch[1]);
          } else {
              return { error: translations['status_error_general'] };
          }

          let scale;
          const scaleKeyMatch = decodedText.match(/scale/i);
          if (!scaleKeyMatch) {
              return { error: translations['status_error_general'] };
          }

          const scaleSearchArea = decodedText.substring(scaleKeyMatch.index + scaleKeyMatch[0].length);
          const scientificMatch = scaleSearchArea.match(/[":]*(-?\d+\.?\d*)[eE]([-+]?\d+)/);
          
          if (scientificMatch) {
              const base = parseFloat(scientificMatch[1]);
              const exponent = parseInt(scientificMatch[2]);
              scale = base * Math.pow(10, exponent);
          } else {
              const standardFloatMatch = scaleSearchArea.match(/[":]*(-?\d*\.\d+)/);
              if (standardFloatMatch) {
                  scale = parseFloat(standardFloatMatch[1]);
              } else {
                  let integerMatch = null;
                  const searchWindow = scaleSearchArea.substring(0, 30);
                  integerMatch = searchWindow.match(/^.*?(\d{1,10})/);

                  if (integerMatch) {
                      const scaleInt = parseInt(integerMatch[1]);
                      scale = scaleInt / 1000000000.0;
                  } else {
                      return { error: translations['status_error_general'] };
                  }
              }
          }

          const currentHeight = 7.6 - (8.3 * scale) - (3 * height);
          const shortestHeight = 7.6 - (8.3 * scale) - (3 * -2.0);
          const tallestHeight = 7.6 - (8.3 * scale) - (3 * 2.0);

          const jsonResult = {
              height_raw: height,
              scale_raw: scale
          };

          return {
              current: currentHeight,
              tallest: tallestHeight,
              shortest: shortestHeight,
              scale: scale,
              timestamp: new Date().getTime(),
              note: "",
              json: jsonResult
          };
        } catch (e) {
            console.error("Calculation failed:", e);
            return { error: translations['status_error_general'] };
        }
      };

      // --- App Component ---
      const backgroundImages = [
        { id: 'bg1', path: 'https://picsum.photos/500/250?random=1' },
        { id: 'bg2', path: 'https://picsum.photos/500/250?random=2' },
        { id: 'bg3', path: 'https://picsum.photos/500/250?random=3' },
        { id: 'bg4', path: 'https://picsum.photos/500/250?random=4' }
      ];

      const backgroundGradients = [
        { id: 'dawn', colors: ['#ffecd2', '#fcb69f'] },
        { id: 'sky', colors: ['#a18cd1', '#fbc2eb'] },
        { id: 'night', colors: ['#09203f', '#537895'] },
      ];

      const App = () => {
        const [activeTab, setActiveTab] = useState('measure');
        const [inputVal, setInputVal] = useState('');
        const [history, setHistory] = useState([]);
        const [lastResult, setLastResult] = useState(null);
        const [status, setStatus] = useState({ text: '', type: 'normal' });
        const [isLoading, setIsLoading] = useState(false);
        const [showGuide, setShowGuide] = useState(false);
        const [showEntryModal, setShowEntryModal] = useState(true);
        const [entryCountdown, setEntryCountdown] = useState(5);

        const [customization, setCustomization] = useState({
            playerName: '',
            bgType: 'gradient',
            bgSource: backgroundGradients[1].colors.join(','), 
            textColor: 'white',
            textAlign: 'center',
            showRange: true,
            uploadedBgUrl: null
        });

        const [potionCount, setPotionCount] = useState(0);
        const [simResult, setSimResult] = useState(null);
        const [simExtremeNotice, setSimExtremeNotice] = useState('');

        const previewCanvasRef = useRef(null);
        const qrCanvasRef = useRef(null);
        const qrFileInputRef = useRef(null);
        const bgFileInputRef = useRef(null);

        // Effects
        useEffect(() => {
            if (showEntryModal && entryCountdown > 0) {
                const timer = setTimeout(() => {
                    setEntryCountdown(prev => prev - 1);
                }, 1000);
                return () => clearTimeout(timer);
            }
        }, [showEntryModal, entryCountdown]);

        useEffect(() => {
            if (status.text) {
                const timer = setTimeout(() => {
                    setStatus({ text: '', type: 'normal' });
                }, 3000);
                return () => clearTimeout(timer);
            }
        }, [status.text]);

        useEffect(() => {
            const savedHistory = localStorage.getItem('skyHeightHistory');
            if (savedHistory) {
                try {
                    setHistory(JSON.parse(savedHistory));
                } catch (e) {
                    console.error("Failed to load history");
                }
            }
        }, []);

        useEffect(() => {
            localStorage.setItem('skyHeightHistory', JSON.stringify(history));
        }, [history]);

        const drawContent = useCallback(() => {
            const canvas = previewCanvasRef.current;
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            if (!ctx) return;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const drawTextOverlay = () => {
                if (!lastResult) return;

                const { playerName, textColor, textAlign, showRange } = customization;

                ctx.fillStyle = textColor === 'white' ? '#FFFFFF' : '#1e293b';
                ctx.textAlign = textAlign;
                ctx.textBaseline = 'top';
                ctx.shadowColor = textColor === 'white' ? 'rgba(0,0,0,0.5)' : 'rgba(255,255,255,0.5)';
                ctx.shadowBlur = 4;

                let x;
                if (textAlign === 'left') x = 30;
                else if (textAlign === 'right') x = canvas.width - 30;
                else x = canvas.width / 2;

                const baseFont = '"Noto Sans SC", sans-serif';

                if (playerName) {
                    ctx.font = `500 24px ${baseFont}`;
                    ctx.fillText(playerName, x, 25);
                }

                ctx.font = `700 80px "Courier New", monospace`;
                ctx.fillText(lastResult.current.toFixed(4), x, playerName ? 65 : 55);
                
                ctx.font = `14px ${baseFont}`;
                ctx.fillText(t('res_current'), x, playerName ? 145 : 135);

                if (showRange) {
                    ctx.font = `16px ${baseFont}`;
                    const rangeText = `${t('res_tallest')} ${lastResult.tallest.toFixed(4)} | ${t('res_shortest')} ${lastResult.shortest.toFixed(4)}`;
                    ctx.fillText(rangeText, x, 190);
                }

                ctx.font = `12px ${baseFont}`;
                ctx.globalAlpha = 0.7;
                ctx.textAlign = 'center';
                ctx.shadowBlur = 0;
                ctx.fillText('Konataå…‰ä¹‹å­èº«é«˜è§‚æµ‹', canvas.width / 2, 225);
                ctx.globalAlpha = 1.0;
            };

            if (customization.bgType === 'gradient') {
                const colors = customization.bgSource.split(',');
                const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
                gradient.addColorStop(0, colors[0]);
                gradient.addColorStop(1, colors[1]);
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                drawTextOverlay();
            } else {
                const img = new Image();
                img.crossOrigin = "Anonymous";
                img.referrerPolicy = "no-referrer";
                img.src = customization.bgType === 'uploaded' && customization.uploadedBgUrl ? customization.uploadedBgUrl : customization.bgSource;
                img.onload = () => {
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = "rgba(0, 0, 0, 0.2)";
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    drawTextOverlay();
                };
                img.onerror = () => {
                    ctx.fillStyle = '#6b8cce';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    drawTextOverlay();
                };
            }
        }, [customization, lastResult]);

        useEffect(() => {
            const timer = setTimeout(() => {
                drawContent();
            }, 50);
            return () => clearTimeout(timer);
        }, [drawContent]);

        const handleCalculate = () => {
            setLastResult(null);
            setIsLoading(true);
            setStatus({ text: t('status_calculating'), type: 'normal' });
            const rawData = inputVal.trim();
            
            if (!rawData) {
                setStatus({ text: t('status_error_empty'), type: 'error' });
                setIsLoading(false);
                return;
            }

            setTimeout(() => {
                const res = decodeAndCalculate(rawData);
                if (res.error) {
                    setStatus({ text: res.error, type: 'error' });
                } else {
                    setLastResult(res);
                    setStatus({ text: t('status_success'), type: 'success' });
                    setHistory(prev => {
                        const newHistory = [res, ...prev];
                        if (newHistory.length > 20) newHistory.pop();
                        return newHistory;
                    });
                    setPotionCount(0);
                    setSimResult(null);
                    setSimExtremeNotice('');
                }
                setIsLoading(false);
            }, 600);
        };

        const handleCopy = () => {
            if (!lastResult) return;
            const copyText = `${t('res_current')} ${lastResult.current.toFixed(4)}\n${t('res_tallest')} ${lastResult.tallest.toFixed(4)}\n${t('res_shortest')} ${lastResult.shortest.toFixed(4)}`;
            navigator.clipboard.writeText(copyText).then(() => {
                setStatus({ text: t('status_copy_success'), type: 'success' });
            }).catch(() => {
                setStatus({ text: t('status_copy_fail'), type: 'error' });
            });
        };

        const handleGenerateImage = () => {
            if (!previewCanvasRef.current) return;
            const link = document.createElement('a');
            const now = new Date();
            link.download = `Sky_Height_${now.getTime()}.png`;
            link.href = previewCanvasRef.current.toDataURL('image/png');
            link.click();
        };

        const handlePotionDrink = () => {
            if (!lastResult) {
                alert(t('sim_error_no_calc'));
                setActiveTab('measure');
                return;
            }
            setSimExtremeNotice('');
            const newRandomHeight = Math.random() * 4.0 - 2.0;
            const newHeightNumber = 7.6 - (8.3 * lastResult.scale) - (3 * newRandomHeight);
            
            setSimResult(newHeightNumber);
            if (newRandomHeight >= 1.96) setSimExtremeNotice(t('sim_extreme_tall'));
            else if (newRandomHeight <= -1.96) setSimExtremeNotice(t('sim_extreme_short'));
            
            setPotionCount(c => c + 1);
        };

        const handleQrUpload = async (file) => {
            if (!file || !file.type.startsWith('image/')) {
                setStatus({ text: t('status_error_general'), type: 'error' });
                return;
            }
            
            const jsQR = window.jsQR;
            if (!jsQR) {
                setStatus({ text: "Error: jsQR not loaded.", type: 'error' });
                return;
            }

            try {
                 const img = new Image();
                 img.src = URL.createObjectURL(file);
                 await new Promise((resolve, reject) => {
                     img.onload = resolve;
                     img.onerror = reject;
                 });

                 const canvas = qrCanvasRef.current;
                 const ctx = canvas.getContext('2d');
                 canvas.width = img.width;
                 canvas.height = img.height;
                 ctx.drawImage(img, 0, 0);
                 
                 const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                 let code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" });

                 if (!code) {
                     code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "attemptBoth" });
                 }

                 if (code && code.data) {
                     setInputVal(code.data);
                 } else {
                     setStatus({ text: t('status_qr_fail'), type: 'error' });
                 }
            } catch (e) {
                 console.error(e);
                 setStatus({ text: t('status_error_general'), type: 'error' });
            }
        };

        const handleBgUpload = (e) => {
            const file = e.target.files?.[0];
            if (file && file.type.startsWith('image/')) {
                if (customization.uploadedBgUrl) {
                    URL.revokeObjectURL(customization.uploadedBgUrl);
                }
                const url = URL.createObjectURL(file);
                setCustomization(prev => ({
                    ...prev,
                    bgType: 'uploaded',
                    uploadedBgUrl: url
                }));
            }
        };

        const handleDeleteHistory = (index) => {
            if (confirm(t('confirm_delete_item'))) {
                setHistory(prev => prev.filter((_, i) => i !== index));
            }
        };

        const handleHistoryNote = (index) => {
            const currentNote = history[index].note || "";
            const newNote = prompt(t('history_note_placeholder'), currentNote);
            if (newNote !== null) {
                const newHistory = [...history];
                newHistory[index].note = newNote.trim();
                setHistory(newHistory);
            }
        };

        const getHeightPercentage = (current, min, max) => {
            if (!min || !max) return 50;
            const pct = ((current - min) / (max - min)) * 100;
            return Math.min(Math.max(pct, 0), 100);
        };

        return (
            <>
                {/* Entry Confirmation Modal */}
                {showEntryModal && (
                    <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/80 backdrop-blur-md transition-all overflow-y-auto">
                        <div className="glass-modal w-full max-w-md rounded-3xl p-6 md:p-8 flex flex-col items-center text-center shadow-2xl border border-white/10 relative overflow-hidden animate-float my-auto">
                            <div className="absolute top-0 left-0 w-full h-full bg-gradient-to-br from-indigo-500/10 to-purple-500/10 pointer-events-none"></div>

                            <h2 className="text-2xl md:text-3xl font-bold mb-4 md:mb-6 text-transparent bg-clip-text bg-gradient-to-r from-sky-200 via-white to-sky-200 tracking-wider">
                                {t('entry_title')}
                            </h2>
                            
                            <div className="space-y-4 md:space-y-5 text-sm text-white/90 leading-relaxed mb-4 md:mb-6 text-left bg-white/5 p-4 md:p-5 rounded-2xl border border-white/10 shadow-inner w-full">
                                <p dangerouslySetInnerHTML={{__html: t('entry_intro')}}></p>
                                <div className="h-px bg-white/10 my-1"></div>
                                <p className="bg-rose-500/20 p-3 rounded-lg border border-rose-500/30" dangerouslySetInnerHTML={{__html: t('entry_warning')}}></p>
                            </div>

                            <div className="w-full flex flex-col items-center mb-4 md:mb-6 gap-3">
                                <p className="text-xs text-sky-200/80 font-bold text-center leading-relaxed">
                                     BUGæŠ¥å‘Š/æ–°åŠŸèƒ½éœ€æ±‚å»ºè®®ç­‰<br/>
                                     è”ç³»QQï¼š3284669002
                                 </p>
                                 <a 
                                     href="https://qm.qq.com/q/TWmvW2gVEe" 
                                     target="_blank" 
                                     rel="noopener noreferrer"
                                     className="bg-violet-600 hover:bg-violet-500 text-white font-bold py-2 px-6 rounded-lg shadow-md hover:shadow-violet-500/40 transition-all text-sm inline-block"
                                 >
                                     ç‚¹å‡»æ·»åŠ å¥½å‹
                                 </a>
                            </div>

                            <button 
                                disabled={entryCountdown > 0}
                                onClick={() => setShowEntryModal(false)}
                                className={`w-full py-3 md:py-4 rounded-xl font-bold text-lg tracking-wide transition-all transform duration-300 ${
                                    entryCountdown > 0 
                                    ? 'bg-white/5 text-white/30 cursor-not-allowed border border-white/5' 
                                    : 'bg-gradient-to-r from-sky-500 to-indigo-600 text-white shadow-lg hover:shadow-sky-500/40 hover:scale-[1.02] active:scale-95 border border-white/20'
                                }`}
                            >
                                {entryCountdown > 0 ? t('entry_btn_wait').replace('%s', entryCountdown.toString()) : t('entry_btn')}
                            </button>
                        </div>
                    </div>
                )}

                {/* Main Content */}
                <div className={`glass rounded-3xl p-5 md:p-8 w-full text-white shadow-2xl transition-all duration-700 my-auto ${showEntryModal ? 'blur-sm scale-95 opacity-50 pointer-events-none' : 'blur-0 scale-100 opacity-100'}`}>
                    <header className="text-center mb-6 md:mb-8 relative">
                        <div className="w-16 h-1 bg-white/30 mx-auto rounded-full mb-4"></div>
                        <h1 className="text-2xl md:text-3xl font-bold tracking-wider drop-shadow-md mb-2">{t('title')}</h1>
                    </header>

                    <div className="flex bg-black/40 p-1 rounded-2xl mb-6 md:mb-8 relative overflow-hidden backdrop-blur-sm">
                        {['measure', 'sim', 'history'].map((tab) => (
                            <button
                                key={tab}
                                onClick={() => setActiveTab(tab)}
                                className={`flex-1 py-2 rounded-xl text-sm font-bold transition-all duration-300 relative z-10 ${activeTab === tab ? 'bg-white text-indigo-900 shadow-md scale-105' : 'text-white/60 hover:text-white hover:bg-white/5'}`}
                            >
                                {t(`tab_${tab}`)}
                            </button>
                        ))}
                    </div>

                    <div className="min-h-[300px]">
                        {activeTab === 'measure' && (
                            <div className="animate-float space-y-6">
                                {!lastResult ? (
                                    <>
                                        <div 
                                            className="border-2 border-dashed border-white/20 bg-black/20 rounded-3xl p-6 md:p-8 text-center cursor-pointer hover:bg-black/30 hover:border-white/50 transition-all group active:scale-95 touch-manipulation"
                                            onClick={() => qrFileInputRef.current?.click()}
                                            onDragOver={(e) => { e.preventDefault(); e.stopPropagation(); }}
                                            onDrop={(e) => { 
                                                e.preventDefault(); e.stopPropagation(); 
                                                if (e.dataTransfer.files.length > 0) handleQrUpload(e.dataTransfer.files[0]);
                                            }}
                                        >
                                            <div className="w-16 h-16 bg-white/10 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform">
                                                <svg xmlns="http://www.w3.org/2000/svg" className="h-8 w-8 text-white/90" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                                                </svg>
                                            </div>
                                            <p className="font-medium text-white/80">{t('upload_instruction')}</p>
                                            <input type="file" ref={qrFileInputRef} className="hidden" accept="image/*" onChange={(e) => e.target.files?.length && handleQrUpload(e.target.files[0])} />
                                        </div>

                                        <div className="relative">
                                            <input 
                                                type="text" 
                                                className="w-full glass-input rounded-xl px-4 py-3 pl-10 text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-sky-400 transition-all bg-black/30 text-base"
                                                placeholder={t('placeholder')}
                                                value={inputVal}
                                                onChange={(e) => setInputVal(e.target.value)}
                                            />
                                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 absolute left-3 top-3.5 text-white/50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                                            </svg>
                                        </div>

                                        <button 
                                            onClick={handleCalculate}
                                            disabled={isLoading}
                                            className="w-full glass-btn py-4 rounded-xl font-bold text-lg tracking-wide hover:bg-white/20 active:scale-95 transition-all flex items-center justify-center gap-2 text-white touch-manipulation"
                                        >
                                            {isLoading ? (
                                                <svg className="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                </svg>
                                            ) : t('calculate_btn')}
                                        </button>
                                        
                                        <div className="text-center pt-2">
                                            <button 
                                                onClick={() => setShowGuide(true)}
                                                className="text-xs text-white/60 hover:text-white transition-colors py-2 px-6 border border-white/10 rounded-full bg-black/20 hover:bg-black/40 touch-manipulation"
                                            >
                                                {t('toggle_instructions')}
                                            </button>
                                        </div>
                                    </>
                                ) : (
                                    <div className="space-y-6">
                                        <div className="text-center">
                                            <span className="text-sm uppercase tracking-widest text-white/60">{t('res_current')}</span>
                                            <div className="text-6xl font-mono font-bold my-2 text-transparent bg-clip-text bg-gradient-to-r from-white to-sky-200 drop-shadow-2xl filter">
                                                {lastResult.current.toFixed(4)}
                                            </div>
                                            <div className="flex justify-between text-xs text-white/60 px-8">
                                                <span>Min: {lastResult.shortest.toFixed(4)}</span>
                                                <span>Max: {lastResult.tallest.toFixed(4)}</span>
                                            </div>
                                            
                                            <div className="h-2 w-full bg-black/40 rounded-full mt-3 relative overflow-hidden border border-white/5">
                                                <div 
                                                    className="h-full bg-sky-300 shadow-[0_0_12px_rgba(125,211,252,0.8)] rounded-full transition-all duration-1000 ease-out"
                                                    style={{ width: `${getHeightPercentage(lastResult.current, lastResult.shortest, lastResult.tallest)}%` }}
                                                ></div>
                                            </div>
                                        </div>

                                        <div className="grid grid-cols-2 gap-3">
                                            <button onClick={handleCopy} className="glass-btn py-3 rounded-lg text-sm hover:bg-white/20 transition-colors bg-black/20 touch-manipulation">
                                                {status.text === t('status_copy_success') ? t('copy_btn_copied') : t('copy_btn')}
                                            </button>
                                            <button onClick={() => {setLastResult(null); setInputVal('');}} className="glass-btn py-3 rounded-lg text-sm hover:bg-white/20 transition-colors bg-black/20 touch-manipulation">
                                                é‡æ–°æµ‹é‡
                                            </button>
                                        </div>
                                        
                                        <div className="bg-black/30 rounded-2xl p-4 border border-white/5">
                                            <h3 className="font-bold mb-3 text-sm flex items-center gap-2 text-white/90">
                                                <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                                </svg>
                                                {t('customize_image')}
                                            </h3>
                                            
                                            <div className="mb-4 rounded-xl overflow-hidden shadow-lg border border-white/10">
                                                <canvas ref={previewCanvasRef} width={500} height={250} className="w-full h-auto block" />
                                            </div>

                                            <div className="space-y-3">
                                                <input 
                                                    type="text" 
                                                    placeholder={t('player_name_placeholder')}
                                                    className="w-full bg-black/40 border border-white/10 rounded-lg px-3 py-2 text-base text-white placeholder-white/30 focus:outline-none focus:border-white/30"
                                                    value={customization.playerName}
                                                    onChange={e => setCustomization({...customization, playerName: e.target.value})}
                                                />
                                                
                                                <div>
                                                    <button 
                                                        onClick={() => bgFileInputRef.current?.click()}
                                                        className={`w-full py-2 border border-dashed rounded-lg text-xs transition-all flex items-center justify-center gap-2 touch-manipulation ${customization.bgType === 'uploaded' ? 'border-sky-400 text-sky-200 bg-sky-500/10' : 'border-white/30 text-white/60 hover:text-white hover:bg-white/5 hover:border-white/60'}`}
                                                    >
                                                        <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                                                        </svg>
                                                        {t('bg_style_upload')}
                                                    </button>
                                                    <input 
                                                        type="file" 
                                                        ref={bgFileInputRef}
                                                        className="hidden" 
                                                        accept="image/*" 
                                                        onChange={handleBgUpload}
                                                    />
                                                </div>

                                                <div className="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
                                                    {backgroundGradients.map(grad => (
                                                        <div 
                                                            key={grad.id}
                                                            className={`w-8 h-8 rounded-full flex-shrink-0 cursor-pointer border-2 shadow-sm touch-manipulation ${customization.bgType === 'gradient' && customization.bgSource === grad.colors.join(',') ? 'border-white scale-110' : 'border-transparent opacity-80'}`}
                                                            style={{ background: `linear-gradient(135deg, ${grad.colors[0]}, ${grad.colors[1]})` }}
                                                            onClick={() => setCustomization({...customization, bgType: 'gradient', bgSource: grad.colors.join(',')})}
                                                        />
                                                    ))}
                                                    {backgroundImages.map(img => (
                                                        <div 
                                                            key={img.id}
                                                            className={`w-8 h-8 rounded-full flex-shrink-0 cursor-pointer border-2 bg-cover shadow-sm touch-manipulation ${customization.bgType === 'image' && customization.bgSource === img.path ? 'border-white scale-110' : 'border-transparent opacity-80'}`}
                                                            style={{ backgroundImage: `url(${img.path})` }}
                                                            onClick={() => setCustomization({...customization, bgType: 'image', bgSource: img.path})}
                                                        />
                                                    ))}
                                                </div>

                                                <button onClick={handleGenerateImage} className="w-full bg-white/90 text-indigo-900 font-bold py-2 rounded-lg text-sm hover:bg-white transition-colors shadow-lg touch-manipulation">
                                                    {t('image_btn')}
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {activeTab === 'sim' && (
                            <div className="animate-float space-y-6 text-center">
                                <div className="w-20 h-20 bg-gradient-to-tr from-yellow-300 to-orange-500 rounded-full mx-auto shadow-[0_0_20px_rgba(253,186,116,0.4)] flex items-center justify-center mb-4 border border-white/20">
                                    <span className="text-3xl">ğŸ§ª</span>
                                </div>
                                <h2 className="text-xl font-bold">{t('sim_title')}</h2>
                                <p className="text-sm text-white/70 px-4">{t('sim_desc')}</p>

                                {!lastResult ? (
                                    <div className="p-4 bg-rose-500/20 border border-rose-500/30 rounded-xl text-sm text-white/90">
                                        {t('sim_error_no_calc')}
                                        <button onClick={() => setActiveTab('measure')} className="block mx-auto mt-2 underline text-white font-bold">{t('tab_measure')}</button>
                                    </div>
                                ) : (
                                    <>
                                        <div className="glass p-6 rounded-2xl relative overflow-hidden bg-black/20">
                                            <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-white/50 to-transparent"></div>
                                            <div className="text-sm text-white/60 mb-1">{t('sim_result_label')}</div>
                                            <div className="text-4xl font-mono font-bold text-white drop-shadow-md">
                                                {simResult !== null ? simResult.toFixed(4) : '?.????'}
                                            </div>
                                            {simExtremeNotice && (
                                                <div className="text-gold font-bold text-xs mt-1 animate-bounce">{simExtremeNotice}</div>
                                            )}
                                        </div>

                                        <div className="flex items-center justify-center gap-4 text-sm font-medium">
                                            <span>{t('sim_count_label')} <span className="text-gold text-lg">{potionCount}</span></span>
                                        </div>

                                        <div className="grid grid-cols-2 gap-3">
                                            <button 
                                                onClick={handlePotionDrink}
                                                className="bg-gradient-to-r from-amber-300 to-orange-500 text-amber-950 font-bold py-3 rounded-xl shadow-lg hover:brightness-110 active:scale-95 transition-all touch-manipulation"
                                            >
                                                {t('sim_drink_btn')}
                                            </button>
                                            <button 
                                                onClick={() => { setPotionCount(0); setSimResult(null); }}
                                                className="bg-white/10 text-white font-bold py-3 rounded-xl hover:bg-white/20 transition-all border border-white/10 touch-manipulation"
                                            >
                                                {t('sim_reset_btn')}
                                            </button>
                                        </div>

                                        <div className="mt-4 p-4 bg-black/20 rounded-xl text-left border border-white/5">
                                            <p className="text-xs font-bold text-white/50 mb-2 uppercase">{t('sim_meta_title')}</p>
                                            <div className="space-y-2">
                                                <label className="flex items-center gap-2 text-sm cursor-pointer hover:text-white/80 touch-manipulation">
                                                    <input type="checkbox" className="rounded bg-black/40 border-white/20 text-indigo-500 focus:ring-0 checked:bg-indigo-500" />
                                                    {t('sim_meta_tall')}
                                                </label>
                                                <label className="flex items-center gap-2 text-sm cursor-pointer hover:text-white/80 touch-manipulation">
                                                    <input type="checkbox" className="rounded bg-black/40 border-white/20 text-indigo-500 focus:ring-0 checked:bg-indigo-500" />
                                                    {t('sim_meta_short')}
                                                </label>
                                            </div>
                                        </div>
                                    </>
                                )}
                            </div>
                        )}

                        {activeTab === 'history' && (
                            <div className="space-y-4">
                                <div className="flex justify-between items-center mb-2">
                                    <h3 className="font-bold">{t('history_title')}</h3>
                                    {history.length > 0 && (
                                        <button onClick={() => confirm(t('confirm_clear_history')) && setHistory([])} className="text-xs text-white/60 hover:text-white bg-white/10 px-3 py-1 rounded-full touch-manipulation">
                                            {t('clear_history_btn')}
                                        </button>
                                    )}
                                </div>
                                
                                <div className="space-y-2 max-h-[400px] overflow-y-auto pr-2 custom-scrollbar">
                                    {history.length === 0 ? (
                                        <div className="text-center py-10 text-white/30 italic">
                                            {t('status_copy_empty')}
                                        </div>
                                    ) : (
                                        history.map((item, index) => (
                                            <div key={index} className="bg-black/30 rounded-xl p-4 relative group hover:bg-black/40 transition-colors border border-white/5">
                                                <button 
                                                    onClick={() => handleDeleteHistory(index)}
                                                    className="absolute top-2 right-2 opacity-0 group-hover:opacity-100 text-white/50 hover:text-red-300 transition-opacity p-1 touch-manipulation"
                                                >
                                                    âœ•
                                                </button>
                                                <div className="flex justify-between items-baseline">
                                                    <span className="font-mono font-bold text-lg text-sky-200">{item.current.toFixed(4)}</span>
                                                    <span className="text-xs text-white/40">{new Date(item.timestamp).toLocaleDateString()}</span>
                                                </div>
                                                <div 
                                                    onClick={() => handleHistoryNote(index)}
                                                    className="text-xs mt-1 text-white/60 hover:text-white cursor-pointer truncate flex items-center gap-1 touch-manipulation"
                                                >
                                                    <span className="opacity-50">âœ</span> {item.note || t('history_note_placeholder')}
                                                </div>
                                            </div>
                                        ))
                                    )}
                                </div>
                            </div>
                        )}
                    </div>

                    {showGuide && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm transition-opacity" onClick={() => setShowGuide(false)}>
                            <div 
                                className="glass-modal w-full max-w-md max-h-[90dvh] rounded-2xl p-6 relative flex flex-col shadow-2xl overflow-hidden" 
                                onClick={e => e.stopPropagation()}
                            >
                                <button 
                                    onClick={() => setShowGuide(false)}
                                    className="absolute top-4 right-4 text-white/60 hover:text-white p-2 touch-manipulation z-10"
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>

                                <h2 className="text-xl font-bold mb-4 text-center sticky top-0 bg-transparent">{t('toggle_instructions')}</h2>
                                
                                <div className="overflow-y-auto custom-scrollbar pr-2 space-y-6 flex-1">
                                    <div className="space-y-6">
                                        <div className="p-3 bg-indigo-500/20 rounded-lg border border-indigo-500/30">
                                            <p className="text-white font-bold text-center text-sm" dangerouslySetInnerHTML={{__html: t('inst_4')}} />
                                        </div>

                                        <div className="space-y-2">
                                            <p className="text-sm text-white/90 leading-relaxed font-medium" dangerouslySetInnerHTML={{__html: t('inst_1')}} />
                                            <div className="rounded-lg overflow-hidden border border-white/10 shadow-lg bg-black/20">
                                                <img 
                                                    src="https://gitee.com/konatatata/material/raw/master/p1.png" 
                                                    alt="Guide Step 1" 
                                                    loading="lazy"
                                                    referrerPolicy="no-referrer"
                                                    className="w-full h-auto object-cover block"
                                                    onError={(e) => {
                                                        e.target.style.display = 'none';
                                                    }}
                                                />
                                            </div>
                                        </div>

                                        <div className="space-y-2">
                                            <p className="text-sm text-white/90 leading-relaxed font-medium" dangerouslySetInnerHTML={{__html: t('inst_2')}} />
                                            <div className="rounded-lg overflow-hidden border border-white/10 shadow-lg bg-black/20">
                                                <img 
                                                    src="https://gitee.com/konatatata/material/raw/master/p2.png" 
                                                    alt="Guide Step 2" 
                                                    loading="lazy"
                                                    referrerPolicy="no-referrer"
                                                    className="w-full h-auto object-cover block"
                                                    onError={(e) => {
                                                        e.target.style.display = 'none';
                                                    }}
                                                />
                                            </div>
                                        </div>
                                    </div>

                                    <div className="pt-6 border-t border-white/10 space-y-4">
                                         <div className="p-3 bg-purple-500/20 rounded-lg border border-purple-500/30">
                                            <p className="text-white font-bold text-center text-sm" dangerouslySetInnerHTML={{__html: t('inst_5')}} />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    <canvas ref={qrCanvasRef} className="hidden" />

                    {status.text && (
                        <div className={`fixed bottom-6 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-full text-sm font-medium shadow-xl backdrop-blur-md transition-all z-50 whitespace-nowrap animate-float ${status.type === 'error' ? 'bg-rose-600 text-white' : 'bg-white text-indigo-900'}`}>
                            {status.text}
                        </div>
                    )}
                    
                    <div className="mt-8 text-center text-xs space-y-1">
                        <p className="text-white/40">{t('disclaimer_free')}</p>
                        <p className="text-rose-400 font-medium">{t('disclaimer_privacy')}</p>
                    </div>
                </div>
            </>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
